module.exports=function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s="./index.js")}({"./index.js":
/*!******************!*\
  !*** ./index.js ***!
  \******************/
/*! exports provided: loginFunction, signupFunction, validateTokenFunction, generateCodeFunction, validateCodeFunction, sendEmailValidationFunction, validateEmailTokenFunction, isAliveFunction */function(e,t,n){"use strict";n.r(t),n.d(t,"loginFunction",function(){return d}),n.d(t,"signupFunction",function(){return l}),n.d(t,"validateTokenFunction",function(){return c}),n.d(t,"generateCodeFunction",function(){return u}),n.d(t,"validateCodeFunction",function(){return f}),n.d(t,"sendEmailValidationFunction",function(){return y}),n.d(t,"validateEmailTokenFunction",function(){return g}),n.d(t,"isAliveFunction",function(){return p});var r=n(/*! ./src/controllers/user/login */"./src/controllers/user/login.js"),o=n(/*! ./src/controllers/user/signup */"./src/controllers/user/signup.js"),s=n(/*! ./src/controllers/user/validateToken */"./src/controllers/user/validateToken.js"),a=n(/*! ./src/controllers/user/phone */"./src/controllers/user/phone.js"),i=n(/*! ./src/controllers/user/email */"./src/controllers/user/email.js");const d=r.login,l=o.signup,c=s.validateToken,u=a.generateCode,f=a.validateCode,y=i.sendEmailValidation,g=i.validateEmailToken,p=()=>({statusCode:200,headers:{"Access-Control-Allow-Credentials":!0,"Access-Control-Allow-Origin":"*","Content-Type":"application/json"},body:JSON.stringify({})})},"./src/controllers/user/email.js":
/*!***************************************!*\
  !*** ./src/controllers/user/email.js ***!
  \***************************************/
/*! exports provided: sendEmailValidation, validateEmailToken */function(e,t,n){"use strict";n.r(t),n.d(t,"sendEmailValidation",function(){return f}),n.d(t,"validateEmailToken",function(){return y});var r=n(/*! aws-sdk */"aws-sdk"),o=n.n(r),s=n(/*! jsonwebtoken */"jsonwebtoken"),a=n.n(s),i=n(/*! ../../status */"./src/status.js"),d=n(/*! ../../db/Mongodb */"./src/db/Mongodb.js");o.a.config.region="us-west-2";const l=new o.a.SES;let c=null;const u={"Access-Control-Allow-Credentials":!0,"Access-Control-Allow-Origin":"*","Content-Type":"application/json"},f=async e=>{const{email:t,ida:n}=JSON.parse(e.body),{SECRET:r,MONGO_URL:o}=e.stageVariables||{SECRET:"weednaoehganja",MONGO_URL:process.env.MONGO_URL};let s=/^[a-z0-9._-]{2,}@[a-z0-9]{2,}\.[a-z]{2,}(\.[a-z]{2})?$/.test(t);if(!s)return{statusCode:i.default.BAD_REQUEST.code,headers:u,body:JSON.stringify({error:"email/invalid-email"})};if(!(s=/^[0-9a-fA-F]{24}$/.test(n)))return{statusCode:i.default.BAD_REQUEST.code,headers:u,body:JSON.stringify({error:"email/invalid-ida"})};const f={email:{address:t,valid:!1,token:a.a.sign({email:t,ida:n},r,{expiresIn:"1h"})}},y=(c=await Object(d.default)({conn:c,mongoUrl:o})).model("users");let g,p;try{g=await y.findOneAndUpdate({_id:n},f,{new:!0})}catch(e){return{statusCode:i.default.INTERNAL_SERVER_ERROR.code,headers:u,body:JSON.stringify({error:e})}}if(!g)return{statusCode:i.default.BAD_REQUEST.code,headers:u,body:JSON.stringify({error:"phone/invalid-ida"})};try{p=await(e=>new Promise((t,n)=>{l.sendEmail((e=>({Destination:{ToAddresses:[e.address]},Message:{Body:{Html:{Charset:"UTF-8",Data:"This is the message body in text format."},Text:{Charset:"UTF-8",Data:"This is the message body in text format."}},Subject:{Charset:"UTF-8",Data:"Test email"}},Source:"gabrielfurlan05@gmail.com"}))(e),(e,r)=>{e?(console.log(e,e.stack),n(e)):t(r)})}))(f.email)}catch(e){return{statusCode:i.default.BAD_REQUEST.code,headers:u,body:JSON.stringify({error:"email/to-send"})}}return{statusCode:i.default.SUCCESS.code,headers:u,body:JSON.stringify(p)}},y=async e=>{const{ida:t,token:n}=JSON.parse(e.body),{SECRET:r,MONGO_URL:o}=e.stageVariables||{SECRET:"weednaoehganja",MONGO_URL:process.env.MONGO_URL};if(!/^[0-9a-fA-F]{24}$/.test(t))return{statusCode:i.default.BAD_REQUEST.code,headers:u,body:JSON.stringify({error:"email/invalid-ida"})};const s=(c=await Object(d.default)({conn:c,mongoUrl:o})).model("users");let l;try{l=await s.findOne({_id:t})}catch(e){return{statusCode:i.default.INTERNAL_SERVER_ERROR.code,headers:u,body:JSON.stringify({error:e})}}if(!l)return{statusCode:i.default.BAD_REQUEST.code,headers:u,body:JSON.stringify({error:"email/invalid-ida"})};if(l.email.token!==n)return{statusCode:i.default.BAD_REQUEST.code,headers:u,body:JSON.stringify({error:"email/invalid-token"})};try{await(()=>new Promise((e,t)=>{a.a.verify(n,r,(n,r)=>{n?t(n):e(r)})}))()}catch(e){return"TokenExpiredError"===e.name?{statusCode:i.default.BAD_REQUEST.code,headers:u,body:JSON.stringify({error:"email/expired-token"})}:{statusCode:i.default.BAD_REQUEST.code,headers:u,body:JSON.stringify({error:"email/invalid-token"})}}try{await s.findOneAndUpdate({_id:t},{"email.valid":!0},{new:!0})}catch(e){return{statusCode:i.default.INTERNAL_SERVER_ERROR.code,headers:u,body:JSON.stringify({error:e})}}return{statusCode:i.default.SUCCESS.code,headers:u,body:JSON.stringify({ida:t,email:l.email.address})}}},"./src/controllers/user/login.js":
/*!***************************************!*\
  !*** ./src/controllers/user/login.js ***!
  \***************************************/
/*! exports provided: login, default */function(e,t,n){"use strict";n.r(t),n.d(t,"login",function(){return f});var r=n(/*! bcrypt */"bcrypt"),o=n.n(r),s=n(/*! jsonwebtoken */"jsonwebtoken"),a=n.n(s),i=n(/*! dotenv */"dotenv"),d=n.n(i),l=n(/*! ../../status */"./src/status.js"),c=n(/*! ../../db/Mongodb */"./src/db/Mongodb.js");d.a.config();let u=null;const f=async e=>{const{username:t,password:n}=JSON.parse(e.body),{SECRET:r,MONGO_URL:s}=e.stageVariables||{SECRET:"weednaoehganja",MONGO_URL:process.env.MONGO_URL};try{const e=(u=await Object(c.default)({conn:u,mongoUrl:s})).model("users"),i=await e.findOne({username:t});if(!i)return{status:l.default.UNAUTHORIZED.code,headers:{"Access-Control-Allow-Credentials":!0,"Access-Control-Allow-Origin":"*","Content-Type":"application/json"},body:JSON.stringify({error:"user/not-found"})};if(!await o.a.compare(n,i.password))return{statusCode:l.default.UNAUTHORIZED.code,headers:{"Access-Control-Allow-Credentials":!0,"Access-Control-Allow-Origin":"*","Content-Type":"application/json"},body:JSON.stringify({error:"user/wrong-password"})};const d=a.a.sign({username:t,ida:i._id},r,{expiresIn:"1h"});return{statusCode:l.default.ACCEPTED.code,headers:{"Access-Control-Allow-Credentials":!0,"Access-Control-Allow-Origin":"*","Content-Type":"application/json"},body:JSON.stringify({data:{ida:i._id,token:d}})}}catch(e){return{statusCode:l.default.INTERNAL_SERVER_ERROR.code,headers:{"Access-Control-Allow-Credentials":!0,"Access-Control-Allow-Origin":"*","Content-Type":"application/json"},body:JSON.stringify({error:e})}}};t.default=f},"./src/controllers/user/phone.js":
/*!***************************************!*\
  !*** ./src/controllers/user/phone.js ***!
  \***************************************/
/*! exports provided: generateCode, validateCode */function(e,t,n){"use strict";n.r(t),n.d(t,"generateCode",function(){return c}),n.d(t,"validateCode",function(){return u});var r=n(/*! aws-sdk */"aws-sdk"),o=n.n(r),s=n(/*! ../../db/Mongodb */"./src/db/Mongodb.js"),a=n(/*! ../../status */"./src/status.js");o.a.config.region="us-west-2";let i=null;const d={"Access-Control-Allow-Credentials":!0,"Access-Control-Allow-Origin":"*","Content-Type":"application/json"},l=()=>{let e="";for(let t=0;t<6;t+=1)e+=0===t?"123456789".charAt(Math.floor(Math.random()*"123456789".length)):"0123456789".charAt(Math.floor(Math.random()*"0123456789".length));return e},c=async e=>{const{phone:t,ida:n}=JSON.parse(e.body);let r=/^\+[0-9]{13}$/.test(t);if(!r)return{statusCode:a.default.BAD_REQUEST.code,headers:d,body:JSON.stringify({error:"phone/invalid-number"})};if(!(r=/^[0-9a-fA-F]{24}$/.test(n)))return{statusCode:a.default.BAD_REQUEST.code,headers:d,body:JSON.stringify({error:"phone/invalid-ida"})};const c={phone:{number:t,valid:!1,confirmation_code:l()}},{MONGO_URL:u}=e.stageVariables||{MONGO_URL:process.env.MONGO_URL},f=(i=await Object(s.default)({conn:i,mongoUrl:u})).model("users");let y;try{y=await f.findOneAndUpdate({_id:n},c,{new:!0})}catch(e){return{statusCode:a.default.INTERNAL_SERVER_ERROR.code,headers:d,body:JSON.stringify({error:e})}}if(!y)return{statusCode:a.default.BAD_REQUEST.code,headers:d,body:JSON.stringify({error:"phone/invalid-ida"})};const g=new o.a.SNS,p={Message:`IDA-${c.phone.confirmation_code} é o código de confirmação de seu telefone para sua conta no SOM/IDA.`,MessageStructure:"string",PhoneNumber:t},O=await g.publish(p),E=await O.send();return E.error?{statusCode:a.default.INTERNAL_SERVER_ERROR.code,headers:d,body:JSON.stringify({error:E.error})}:{statusCode:a.default.SUCCESS.code,headers:d,body:JSON.stringify({data:{ida:y._id,phone:{number:t,valid:!1}}})}},u=async e=>{const{code:t,ida:n}=JSON.parse(e.body);if(!/^[0-9a-fA-F]{24}$/.test(n))return{statusCode:a.default.BAD_REQUEST.code,headers:d,body:JSON.stringify({error:"phone/invalid-ida"})};const{MONGO_URL:r}=e.stageVariables||{MONGO_URL:process.env.MONGO_URL},o=(i=await Object(s.default)({conn:i,mongoUrl:r})).model("users");let l;try{l=await o.findOne({_id:n})}catch(e){return{statusCode:a.default.INTERNAL_SERVER_ERROR.code,headers:d,body:JSON.stringify({error:e})}}if(!l)return{statusCode:a.default.BAD_REQUEST.code,headers:d,body:JSON.stringify({error:"phone/invalid-ida"})};if(l.phone.confirmation_code!==t)return{statusCode:a.default.BAD_REQUEST.code,headers:d,body:JSON.stringify({error:"phone/invalid-code"})};const c={phone:{number:l.phone.number,valid:!0,confirmation_code:null}};try{l=await o.findOneAndUpdate({_id:n},c,{new:!0})}catch(e){return{statusCode:a.default.INTERNAL_SERVER_ERROR.code,headers:d,body:JSON.stringify({err:e})}}return{statusCode:a.default.SUCCESS.code,headers:d,body:JSON.stringify({data:{ida:l._id,phone:{number:l.phone.number,valid:!0}}})}}},"./src/controllers/user/signup.js":
/*!****************************************!*\
  !*** ./src/controllers/user/signup.js ***!
  \****************************************/
/*! exports provided: signup, default */function(e,t,n){"use strict";n.r(t),n.d(t,"signup",function(){return u});var r=n(/*! dotenv */"dotenv"),o=n.n(r),s=n(/*! jsonwebtoken */"jsonwebtoken"),a=n.n(s),i=n(/*! ../utils */"./src/controllers/utils.js"),d=n(/*! ../../db/Mongodb */"./src/db/Mongodb.js"),l=n(/*! ../../status */"./src/status.js");o.a.config();let c=null;const u=async e=>{const{username:t,password:n}=JSON.parse(e.body),{SECRET:r,MONGO_URL:o}=e.stageVariables||{SECRET:"weednaoehganja",MONGO_URL:process.env.MONGO_URL};try{const e=(c=await Object(d.default)({conn:c,mongoUrl:o})).model("users");if(await e.findOne({username:t}))return{statusCode:l.default.UNAUTHORIZED.code,headers:{"Access-Control-Allow-Credentials":!0,"Access-Control-Allow-Origin":"*","Content-Type":"application/json"},body:JSON.stringify({error:"auth/duplicated-user"})};const s=new e({username:t,password:await Object(i.hashPassword)(n)});await s.save();const u=a.a.sign({username:t,ida:s._id},r,{expiresIn:"1h"});return{statusCode:l.default.CREATED.code,headers:{"Access-Control-Allow-Credentials":!0,"Access-Control-Allow-Origin":"*","Content-Type":"application/json"},body:JSON.stringify({data:{ida:s._id,token:u}})}}catch(e){return{statusCode:l.default.INTERNAL_SERVER_ERROR.code,headers:{"Access-Control-Allow-Credentials":!0,"Access-Control-Allow-Origin":"*","Content-Type":"application/json"},body:JSON.stringify({error:e})}}};t.default=u},"./src/controllers/user/validateToken.js":
/*!***********************************************!*\
  !*** ./src/controllers/user/validateToken.js ***!
  \***********************************************/
/*! exports provided: validateToken, default */function(e,t,n){"use strict";n.r(t),n.d(t,"validateToken",function(){return d});var r=n(/*! jsonwebtoken */"jsonwebtoken"),o=n.n(r),s=n(/*! dotenv */"dotenv"),a=n.n(s),i=n(/*! ../../status */"./src/status.js");a.a.config();const d=async e=>{const{token:t}=JSON.parse(e.body),{SECRET:n}=e.stageVariables||{SECRET:"weednaoehganja"};try{const e=await o.a.verify(t,n);return{statusCode:200,headers:{"Access-Control-Allow-Credentials":!0,"Access-Control-Allow-Origin":"*","Content-Type":"application/json"},body:JSON.stringify(e)}}catch(e){return{statusCode:i.default.UNAUTHORIZED.code,headers:{"Access-Control-Allow-Credentials":!0,"Access-Control-Allow-Origin":"*","Content-Type":"application/json"},body:JSON.stringify({error:i.default.UNAUTHORIZED.tag})}}};t.default=d},"./src/controllers/utils.js":
/*!**********************************!*\
  !*** ./src/controllers/utils.js ***!
  \**********************************/
/*! exports provided: hashPassword, default */function(e,t,n){"use strict";n.r(t),n.d(t,"hashPassword",function(){return s});var r=n(/*! bcrypt */"bcrypt"),o=n.n(r);const s=async e=>{return await new Promise((t,n)=>{o.a.hash(e,10,(e,r)=>{e&&n(e),t(r)})})};t.default=s},"./src/db/Mongodb.js":
/*!***************************!*\
  !*** ./src/db/Mongodb.js ***!
  \***************************/
/*! exports provided: default */function(e,t,n){"use strict";n.r(t);var r=n(/*! mongoose */"mongoose"),o=n.n(r),s=n(/*! ./models/users.model */"./src/db/models/users.model.js");o.a.Promise=global.Promise,t.default=async({conn:e,mongoUrl:t="mongodb://localhost/auth-ida"})=>{try{if(!e){console.log("=> using new database connection"),o.a.model("users",s.default);const e=await o.a.createConnection(t,{bufferCommands:!1,bufferMaxEntries:0,keepAlive:!0});return e.model("users",s.default),e}return console.log("=> using existing database connection"),e}catch(e){throw e}}},"./src/db/models/users.model.js":
/*!**************************************!*\
  !*** ./src/db/models/users.model.js ***!
  \**************************************/
/*! exports provided: default */function(e,t,n){"use strict";n.r(t);var r=n(/*! mongoose */"mongoose");const o=new r.Schema({username:{type:String,unique:!0,required:!0},password:{type:String,required:!0},active:{type:Boolean,default:!0},email:{address:{type:String,default:null,lowercase:!0},token:{type:String,default:null},valid:{type:Boolean,default:!1}},phone:{number:{type:String,default:null},valid:{type:Boolean,default:!1},confirmation_code:{type:String,default:null}},last_login:{type:Date,default:Date.now()}},{usePushEach:!0,timestamps:{updatedAt:"updated_at",createdAt:"created_at"}});t.default=o},"./src/status.js":
/*!***********************!*\
  !*** ./src/status.js ***!
  \***********************/
/*! exports provided: default */function(e,t,n){"use strict";n.r(t),t.default={SUCCESS:{code:200,tag:"success"},CREATED:{code:201,tag:"register"},ACCEPTED:{code:202,tag:"accepted"},BAD_REQUEST:{code:400,tag:"bad-request"},UNAUTHORIZED:{code:401,tag:"unauthorized"},INTERNAL_SERVER_ERROR:{code:500,tag:"internal-server-error"}}},"aws-sdk":
/*!**************************!*\
  !*** external "aws-sdk" ***!
  \**************************/
/*! no static exports found */function(e,t){e.exports=require("aws-sdk")},bcrypt:
/*!*************************!*\
  !*** external "bcrypt" ***!
  \*************************/
/*! no static exports found */function(e,t){e.exports=require("bcrypt")},dotenv:
/*!*************************!*\
  !*** external "dotenv" ***!
  \*************************/
/*! no static exports found */function(e,t){e.exports=require("dotenv")},jsonwebtoken:
/*!*******************************!*\
  !*** external "jsonwebtoken" ***!
  \*******************************/
/*! no static exports found */function(e,t){e.exports=require("jsonwebtoken")},mongoose:
/*!***************************!*\
  !*** external "mongoose" ***!
  \***************************/
/*! no static exports found */function(e,t){e.exports=require("mongoose")}});
//# sourceMappingURL=index.js.map